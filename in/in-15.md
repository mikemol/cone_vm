NOTE: Implemented via tests/conftest.py and documented in IMPLEMENTATION_PLAN.md; this note records the workflow.

This note formalizes **milestone-gated testing** and the **VS Code workflow**
for selecting a milestone in the Testing panel. It complements the acceptance
gates in the implementation plan by making the gate mechanical and repeatable.

---

## 1) The intent

We do not rely on xfail to tell us "what should fail." Instead:

- Each test is tagged with the *earliest* milestone at which it must pass.
- A milestone gate skips tests that are beyond the selected milestone.
- Within the selected milestone, every test is expected to pass.

This keeps expectations explicit, avoids test flakiness, and forces the
plan's acceptance criteria to be executable.

---

## 2) The mechanism (pytest)

We use:

- Markers: `m1`, `m2`, `m3`, `m4`, `m5`
- A gate in `conftest.py` that can select either:
  - **Inclusive mode** (<= milestone) via `--milestone`, or
  - **Banded mode** (exact band) via `--milestone-band`
- Per-milestone pytest configs: `pytest.m1.ini` .. `pytest.m5.ini` (banded)

Example:

- `pytest -c pytest.m2.ini` runs **only** tests marked `m2`
- `pytest -c pytest.m1.ini` runs tests marked `m1` **plus** unmarked tests
- Running `m1` â†’ `m5` in order runs the full suite without rerunning tests
- Inclusive mode is still available: `pytest --milestone=m2` runs `m1` + `m2`

This matches the plan's "acceptance gates" directly, while allowing
banded runs for faster full-suite coverage.

---

## 3) VS Code integration (single toggle, Option A)

VS Code's Testing panel only shows what pytest discovers. We make milestone
selection deterministic by setting the milestone in an env file that the
pytest gate reads during discovery.

Workflow (inclusive, default):

1) Edit `.vscode/pytest.env`:

```
PRISM_MILESTONE=m2
```

2) Refresh tests in VS Code:

- "Testing: Refresh Tests"

3) The Testing panel now shows only tests <= the milestone.

Under the hood:

- `python.testing.pytestArgs` uses the default `pytest.ini`
- `python.testing.envFile` points at `.vscode/pytest.env`
- `conftest.py` reads `PRISM_MILESTONE` and skips tests above that milestone
- If the env is not propagated by the IDE, `conftest.py` falls back to reading
  `.pytest-milestone` (one token like `m2`) or `.vscode/pytest.env`.

This makes VS Code's test list mirror the inclusive milestone gate, without a
manual command line step.

If you want **banded** selection in VS Code, set:

```
PYTEST_ADDOPTS=--milestone-band=m2
```

(Use `--include-unmarked` when running the `m1` band.)

---

## 4) The contract this enforces

At any milestone:

- Inclusive mode: all tests *at or below* the milestone must pass.
- Banded mode: only the selected band runs (plus unmarked if explicitly included).
- Unmarked tests must be assigned to their earliest supported milestone; `m1`
  is the only band that includes them by default.
- No xfail guards are used to "bless failures."

This makes the milestone gate a formal contract, not a convenience flag.

---

## 5) Why this matters

The plan is explicit about acceptance gates (M1, M2, M3, M4). This testing
layout makes those gates:

- Visible in the IDE
- Reproducible on CLI
- Enforced by default

As a result, "milestone complete" becomes a testable, tool-supported state.

---

## 6) Quick reference

CLI (banded):

- `pytest -c pytest.m1.ini`
- `pytest -c pytest.m2.ini`
- `pytest -c pytest.m3.ini`
- `pytest -c pytest.m4.ini`
- `pytest -c pytest.m5.ini`

CLI (inclusive):

- `pytest --milestone=m2`

VS Code:

- edit `.vscode/pytest.env`
- refresh tests

---

If we later want multiple milestones in the UI at once, a multi-root workspace
can be added (Option B). For now, the single env toggle keeps the workflow
simple and deterministic.
