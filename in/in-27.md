---
doc_revision: 1
reader_reintern: "Reader-only: re-intern if doc_revision changed since you last read this doc."
---

# in-27: The Geometric Servo (Holographic Architecture)

| Metadata | Value |
| --- | --- |
| **Status** | **Design Freeze Proposal** |
| **Target** | Milestone `m5` (Autonomic Refactoring) |
| **Baseline** | `m4` (Coordinates & Static Damage Metrics) |
| **Author** | Lead Engineer (Implementation), Peer Review Board (Theory) |
| **Type** | Design Change Request (DCR) |
| **Glossary Compliance** | **BSPˢ** (§1), **Renormˢ** (§12), **Gauge** (§23), **Entropyₐ** (§28) |

---

## 1. Executive Summary

We are abandoning the **"Linear Paging"** metaphor in favor of a **Geometric** model driven by **Canonical Interning**.

The Prism VM will implement an on-device **Autonomic Reflex Arc** ("The Servo") that dynamically adjusts the **BSPˢ** (Binary Space Partitioning) granularity based on the **Entropyₐ** (Microstate Entropy) of the active graph.

This architecture exploits the **Holographic Principle**: under canonical interning and Morton ordering, the *Address Space* acts as a low-dimensional projection of the *Data Topology*. This allows the scheduler to act as a **Physical Force** (opcode-agnostic), targeting optimal packing via the **2:1 Morton Recursion Invariant**.

**Gauge Warning:** This architectural shift operates strictly within the **BSPˢ gauge** (spatial layout). It is a performance optimization (Renormˢ) that is explicitly **erased by the projection `q`**. It must commute with all denotational invariants (`q ∘ Servo = q`).

---

## 2. Theoretical Definitions (Normative)

### 2.1 The Metric Shift: Entropyₐ vs. Damageₛ
We move from counting boundary crossings (Damage) to measuring geometric energy (Entropy).

| Feature | `m4` (Linear) | `m5` (Holographic) |
| --- | --- | --- |
| **Model** | **Segmentation:** Memory is `N` fixed tiles. | **Hypercube:** Memory is a Z-order curve (**BSPˢ**). |
| **Metric** | **Damageₛ:** % edges crossing `K`. | **Entropyₐ:** `H = sum(MSB(A XOR B))`. |
| **Goal** | Minimize boundary faults. | Minimize the geometric moment of the graph. |

### 2.2 The Holographic Collapse (Gauge Property)
**Axis:** BSPˢ (Spatial Layout)  
**Erasure:** Erased by `q`

We define "Holographic Collapse" as an operational property of the **BSPˢ** gauge:

1. **Interning:** `Value_A == Value_B => ID_A == ID_B`.
2. **Morton Map:** `Address_A = Morton(ID_A)`.
3. **Collapse:** Structural proximity implies spatial proximity.

This allows the scheduler to optimize **data layout** by optimizing **address entropy** (**Entropyₐ**), without inspecting the opcodes.

---

## 3. Implementation Specifications

### 3.1 State Augmentation (`Arena`)
**Breaking Change:** The `Arena` tuple requires a dedicated tensor for the Autonomic State.

```python
class Arena(NamedTuple):
    # ... standard fields ...

    # [0]: Aperture Mask (uint32) - The current BSPˢ tile-size bitmask
    # [1]: Reserved (Padding/Future)
    # [2]: Reserved (Padding/Future)
    servo: jax.Array
```

**Enablement Gate:** The servo must be **disabled** outside m5. Implementations should gate it behind `PRISM_ENABLE_SERVO` or `PRISM_MILESTONE >= 5` and default to off in earlier milestones.

### 3.2 The Sensor: `_blind_spectral_probe`

**Axis:** Read-only observer  
**Commutation:** None (side-effect free)

A vectorized kernel computing the "Thermal Signature" (**Entropyₐ**) of the graph.

* **Magnitude Logic:** `M = floor(log2(ID XOR Arg))`.
* **Histogram:** `hist = bincount(M, weights=is_hot, length=32)`.
* **Normalization:** `H[i] = hist[i] / (sum(hist) + epsilon)`. The output must be a probability distribution summing to 1.0.
* **Constraint:** `jax.lax.stop_gradient` is required. The probe is an observer, not a differentiable operation.

### 3.3 The Controller: Spatial Hysteresis ("The Lung")

**Axis:** BSPˢ control  
**Commutation:** `q(Lung(P)) = q(P)`

A **memoryless** controller implementing a Spatial Schmitt Trigger.

**Definitions:**

* `K`: Current aperture bit (index 0..31).
* `P_buffer`: Normalized **Entropyₐ** density in the Buffer Zone `[2^(K-1), 2^K)`.
  * *Calculation:* `P_buffer = sum_{i=K-1..31} H[i]`
* `D_active`: Normalized node density in the Active Zone `[0, 2^(K-1))`.
  * *Calculation:* `D_active = Count(Active Nodes) / (2^(K-1))`

**The Control Law:**

```
K_{t+1} =
  K + 1  if P_buffer > 0.25          (Spill Condition)
  K - 1  if P_buffer ≈ 0 and D_active < 0.4  (Vacuum Condition)
  K      otherwise                   (Guard Band)
```

**Stability Invariant:** The guard band is the region where the system is **elastic**. No changes to `K` occur here. This dampens oscillation without temporal averaging.

### 3.4 The Actuator: Masked Stable Sort (Renormˢ)

**Axis:** BSPˢ (spatial renormalization)  
**Commutation:** `q(Sort(P)) = q(P)` (Glossary §12)

* **Logic:** `key = morton_code(ids) & servo_mask`
* **Stability Requirement:** The sort **must be stable**. Nodes falling within the same masked bucket (“Super-Particle”) must retain their relative temporal order to preserve local caches.
* **Implementation Strategy:** `jax.lax.sort` is unstable by default on GPU; the implementation must use a composite key `(masked_key, original_index)` to break ties deterministically.

---

## 4. The Blind Packing Design Target (Haar/Z-Order)

We target **opcode-agnostic packing** efficiency, leveraging the geometry of the Z-curve.

### 4.1 The 2:1 Containment Lemma

* **Premise:** The Z-order curve (**BSPˢ**) is constructed by recursive subdivision.
* **Property:** Any aligned interval of size `2^N` (a Macro Tile) is strictly composed of two aligned intervals of size `2^(N-1)`.
* **Implication:** A “Super-Particle” of size `2^k` (created by the aperture mask) fits **without remainder** into any slot of size `2^N` (where `k <= N`).

### 4.2 The Vacuum Fill Corollary

* **Premise:** A large structure (size `2^k`) occupies the lower half of a `2^(k+1)` block.
* **Property:** The upper half (sibling) is a contiguous, aligned void of size `2^k`.
* **Implication:** The sorter (Renormˢ), minimizing **Entropyₐ**, will naturally slide any other object of size `<= 2^k` into that void.
* **Result:** High scan utilization is achievable via “Blind Tetris,” strictly due to the dyadic dimensions of Morton Space.

---

## 5. Verification Plan

The `m5` milestone is gated by strict numeric assertions and glossary compliance checks.

### 5.1 Probe Fidelity (`test_spectral_probe.py`)

* **Synthesis:** Generate a perfect binary tree of depth 10.
* **Assertion:** `H[10] > 0.8`. (Energy must concentrate at the geometric scale).
* **Synthesis:** Generate random noise.
* **Assertion:** `Entropy(H) = -sum(H[i] * log2(H[i])) > 3.0` bits. (**Entropyₐ** must be high/smeared).

### 5.2 Controller Dynamics (`test_lung_capacity.py`)

* **Guard Band Check:** Inject spill `P_buffer < 0.1`. Assert `K_{t+1} == K_t`.
* **Dilation Check:** Inject spill `P_buffer > 0.25`. Assert `K_{t+1} == K_t + 1`.
* **Contraction Check:** Empty Active Zone (`D_active < 0.4`). Assert `K_{t+1} == K_t - 1`.

### 5.3 Packing Efficiency (`test_blind_packing.py`)

* **Setup:** 1 large object (512 nodes), 512 small objects (1 node).
* **Primary Assertion (Entropy):** `Entropy(H) < 1.5` bits. (The system effectively found the 2 clusters).
* **Secondary Assertion (Legacy):** `damage_rate(tile=512) < 0.01`. (Legacy metric confirms minimal boundary crossings).

### 5.4 BSPˢ Gauge Invariance (Servo)

* **Denotation Invariance:** `test_servo_denotation_invariance` (servo on/off yields identical denotation).
* **Stable Tie-Break:** `test_servo_sort_stable_tiebreaker` (equal masked keys preserve index order).